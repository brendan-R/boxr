---
title: "Box User-Apps"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{auth-jwt}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE, message=FALSE}
library("conflicted")
library("here")
library("fs")

# this is a bit of a hack - this code is at the start of *each* of the vignettes;
# I would prefer that it appear once

# We want to keep a *single* copy of the figures for the entire site. The 
# reference copy of the figures is in the package directory `man/figures`.
# The first thing we do in this vignette is to copy that directory 
# to an the `vignettes`

dir_source <- here::here("man/figures")
dir_target <- here::here("vignettes")
dir_target_figures <- file.path(dir_target, "figures")

if (dir_exists(dir_target_figures)) {
  dir_delete(dir_target_figures)
}

dir_copy(dir_source, dir_target)
```

```{r}
library(boxr)
```

If you are using RStudio Server or RStudio Cloud, you may wish to use the JWT authentication method.



**1. 'Create New App'**

Go to [https://app.box.com/developers/console](https://app.box.com/developers/console), (when you are logged in) and click on the button 'Create New App', which will guide you through four screens to create your new app.

* On the first, select **Custom App** and click 'Next'.
* On the second, select **OAuth 2.0 with JWT (Server authentication)** and click 'Next'
* On the third, choose a unique name for your app, this can be anything and click 'Next'
* The fourth screen should be a confirmation of successful creation, click 'View Your App'

**2. Set Parameters**

'View Your App' will take you to the **Box Developers Console** and where you will be in the **Configuration** sub-menu by default.

Next you need to adjust options in the following sub-menus:

* Application Access: select "Enterprise"
* Advanced Features: turn on "Perform Actions as Users"  and "Generate User Access Tokens"

Then click "Save Changes" changes (blue button upper right)

Next in the "Add and Manage Public Keys" menu, click "Generate a Public/Private Keypair". This action requies 2-step authentication. If 2-step authentication is not enabled on the box.com account associated with the app being created (it is disabled by default), you will need to activate it to proceed.

This should trigger a JSON file to download, named something like "125699595_j41llffp_config.json". I recomend naming this file to "boxr_config.json" and storing it in your home directory. This tutorial assumes you are doing that.

**3. Authorize your app**

Go to the "Admin Console" via the account dropdown menu in the upper left.

Then select "Enterprise Settings" from the sidebar menu on the left.

Now select the "Apps" tab from the top tabbar.

Scroll down to the "Custom Application" menu and click "Authorize New App".

Enter the `client_id` for your app. This can be found in the downloaded "boxr_config.json" file or in the "Configuration" menu in the [Box Developer Console](https://app.box.com/developers/console)

**4. Connect to R**
This means passing the path to your boxr_config.json and your Box accountID, to `box_auth_jwt()`. You can find your accountID in Account Settings >>> Account Details.

Run:
```{r, eval=FALSE}
# library(boxr)
devtools::install_github("nathancday/boxr@jwt")
box_auth_jwt(
  config_file = "~/boxr_config.json",
  user_id = "9999999999"
  )
```

You should see a nice confirmation message and be happy. 

Apps authenticated by JWT-OAuth 2.0 can potentially be used to administer Box access across users in an organization. This is out of scope for `boxr` at the momen but possible through the Box API. Examples in other languages are available on Box's [Setting Up a JWT App](https://developer.box.com/docs/setting-up-a-jwt-app) and Box actively develops Node and Python SDKs.

**5. And you're done**
If `box_auth_jwt()` worked successfully, the variables `config_file` and `user_id` will be securely stored in your R environment variables. So next time you will only need to call `box_auth_jwt()` and the values will be read in automatically.

The hashed OAuth2.0 token is stored as a global option, for the duration of your R session. `box_auth_jwt()` does not offer an automatic authentication options so you will need to call `box_auth_jwt()` in each session.
